{"version":3,"file":"map.js","sources":["../../src/-private/map.ts"],"sourcesContent":["import {\n  type TrackedStorage,\n  createStorage,\n  getValue,\n  setValue,\n} from 'ember-tracked-storage-polyfill';\n\nexport class TrackedMap<K = unknown, V = unknown> implements Map<K, V> {\n  private collection = createStorage(null, () => false);\n\n  private storages: Map<K, TrackedStorage<null>> = new Map();\n\n  private vals: Map<K, V>;\n\n  private readStorageFor(key: K): void {\n    const { storages } = this;\n    let storage = storages.get(key);\n\n    if (storage === undefined) {\n      storage = createStorage(null, () => false);\n      storages.set(key, storage);\n    }\n\n    getValue(storage);\n  }\n\n  private dirtyStorageFor(key: K): void {\n    const storage = this.storages.get(key);\n\n    if (storage) {\n      setValue(storage, null);\n    }\n  }\n\n  constructor();\n  constructor(entries: readonly (readonly [K, V])[] | null);\n  constructor(iterable: Iterable<readonly [K, V]>);\n  constructor(\n    existing?:\n      | readonly (readonly [K, V])[]\n      | Iterable<readonly [K, V]>\n      | null\n      | undefined,\n  ) {\n    // TypeScript doesn't correctly resolve the overloads for calling the `Map`\n    // constructor for the no-value constructor. This resolves that.\n    this.vals = existing ? new Map(existing) : new Map();\n  }\n\n  // **** KEY GETTERS ****\n  get(key: K): V | undefined {\n    // entangle the storage for the key\n    this.readStorageFor(key);\n\n    return this.vals.get(key);\n  }\n\n  has(key: K): boolean {\n    this.readStorageFor(key);\n\n    return this.vals.has(key);\n  }\n\n  // **** ALL GETTERS ****\n  entries() {\n    getValue(this.collection);\n\n    return this.vals.entries();\n  }\n\n  keys() {\n    getValue(this.collection);\n\n    return this.vals.keys();\n  }\n\n  values() {\n    getValue(this.collection);\n\n    return this.vals.values();\n  }\n\n  forEach(fn: (value: V, key: K, map: Map<K, V>) => void): void {\n    getValue(this.collection);\n\n    this.vals.forEach(fn);\n  }\n\n  get size(): number {\n    getValue(this.collection);\n\n    return this.vals.size;\n  }\n\n  [Symbol.iterator]() {\n    getValue(this.collection);\n\n    return this.vals[Symbol.iterator]();\n  }\n\n  get [Symbol.toStringTag](): string {\n    return this.vals[Symbol.toStringTag];\n  }\n\n  // **** KEY SETTERS ****\n  set(key: K, value: V): this {\n    this.dirtyStorageFor(key);\n    setValue(this.collection, null);\n\n    this.vals.set(key, value);\n\n    return this;\n  }\n\n  delete(key: K): boolean {\n    this.dirtyStorageFor(key);\n    setValue(this.collection, null);\n\n    this.storages.delete(key);\n    return this.vals.delete(key);\n  }\n\n  // **** ALL SETTERS ****\n  clear(): void {\n    this.storages.forEach((s) => setValue(s, null));\n    this.storages.clear();\n\n    setValue(this.collection, null);\n    this.vals.clear();\n  }\n}\n\n// So instanceof works\nObject.setPrototypeOf(TrackedMap.prototype, Map.prototype);\n\nexport class TrackedWeakMap<K extends object = object, V = unknown>\n  implements WeakMap<K, V>\n{\n  private storages: WeakMap<K, TrackedStorage<null>> = new WeakMap();\n\n  private vals: WeakMap<K, V>;\n\n  private readStorageFor(key: K): void {\n    const { storages } = this;\n    let storage = storages.get(key);\n\n    if (storage === undefined) {\n      storage = createStorage(null, () => false);\n      storages.set(key, storage);\n    }\n\n    getValue(storage);\n  }\n\n  private dirtyStorageFor(key: K): void {\n    const storage = this.storages.get(key);\n\n    if (storage) {\n      setValue(storage, null);\n    }\n  }\n\n  constructor();\n  constructor(iterable: Iterable<readonly [K, V]>);\n  constructor(entries: readonly [K, V][] | null);\n  constructor(\n    existing?: readonly [K, V][] | Iterable<readonly [K, V]> | null | undefined,\n  ) {\n    // TypeScript doesn't correctly resolve the overloads for calling the `Map`\n    // constructor for the no-value constructor. This resolves that.\n    this.vals = existing ? new WeakMap(existing) : new WeakMap();\n  }\n\n  get(key: K): V | undefined {\n    this.readStorageFor(key);\n\n    return this.vals.get(key);\n  }\n\n  has(key: K): boolean {\n    this.readStorageFor(key);\n\n    return this.vals.has(key);\n  }\n\n  set(key: K, value: V): this {\n    this.dirtyStorageFor(key);\n\n    this.vals.set(key, value);\n\n    return this;\n  }\n\n  delete(key: K): boolean {\n    this.dirtyStorageFor(key);\n\n    this.storages.delete(key);\n    return this.vals.delete(key);\n  }\n\n  get [Symbol.toStringTag](): string {\n    return this.vals[Symbol.toStringTag];\n  }\n}\n\n// So instanceof works\nObject.setPrototypeOf(TrackedWeakMap.prototype, WeakMap.prototype);\n"],"names":["TrackedMap","collection","createStorage","storages","Map","vals","readStorageFor","key","storage","get","undefined","set","getValue","dirtyStorageFor","setValue","constructor","existing","has","entries","keys","values","forEach","fn","size","Symbol","iterator","toStringTag","value","delete","clear","s","Object","setPrototypeOf","prototype","TrackedWeakMap","WeakMap"],"mappings":"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"}